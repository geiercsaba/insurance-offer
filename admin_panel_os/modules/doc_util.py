additional_txt_1 = "A fedezet kiterjed a nyitott szállítóeszközökkel történő fuvarozás során bekövetkező károkra, de nem terjed ki az ilyen szállításokkal szükségképpen együttjáró veszélyek (jégeső, felhőszakadás, nedvesedés stb.) eredményeként bekövetkező károkra, és a nyitott szállítóeszközökkel történő fuvarozás során bekövetkező hiánykárokra (lopás, rablás vagy bármilyen okból bekövetkezett áruhiány)"
additional_txt_2 = "E záradék alkalmazásával a biztosító kockázatviselése és a biztosítási fedezet kiterjed a dohánytermékekre is. E záradék által nyújtott fedezet azonban nem terjed ki a károsodott illetve elveszett áruk jövedéki adótartamára\nE záradék alapján a biztosítási fedezet fennállásának további feltétele, hogy a biztosított az általános és különös biztosítási feltételekben foglaltak mellett az alábbi együttes előírásokat is betartja: \n- A tehergépjárművek GPS rendszerrel (24 órás követés, állandó on-line kapcsolat a távfelügyeleti központtal, jelkimaradás figyelése, adatmentés, min. 30 napos adattárolás) és működő mobiltelefonnal felszereltek.\n- A megbízó fuvarfeladattal kapcsolatos mindennemű előírását kötelezően be kell tartani.\n- Kizárólag a megbízó által adott előírásoknak megfelelő védelmi szintű, vagy a megbízó által külön listában meghatározott parkolókban állhatnak meg. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.)\n- Amennyiben a megbízó nem határozott meg követelményeket az igénybe vehető parkolókra vonatkozóan, vagy nem írta elő meghatározott parkolók használatát, abban az esetben kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.)\n- Ha a tervezett kiszolgáltatás meghiúsul, az új kiszolgáltatási időpontig kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe.\n- A szállítás teljes tartama alatt zárva kell tartani a rakteret.\n- A pótkocsikon nem lehet semmilyen jelzés, utalás a szállított árura vonatkozóan.\n- Amennyiben a fuvarozás két sofőrrel történik,  az egyik gépjárművezetőnek mindig az autóban kell tartózkodnia.\n- A fuvarfeladatot teljesítő gépjárművezetőnek / gépjárművezetőknek legalább 3 hónapos munkaviszonnyal kell rendelkezni a biztosítottnál\n- A gépjárművezető kiszolgáltatás során köteles ellenőrizni, hogy a fuvarlevélen vagy szállítólevélen megjelölt címzett neve szerinti bélyegzőt használtak–e átvételkor. Eltérés esetén a biztosított még a kiszolgáltatás befejezése, illetve a helyszín elhagyása előtt köteles a megbízóval egyeztetni az eltérést és az egyeztetés eredményét írásban is megküldeni a megbízó részére.\nA dohányárukban keletkezett károkra az önrészesedés mértéke 20%, de minimum 100 000 Ft"
additional_txt_3 = "E záradék alapján a biztosítási fedezet fennállásának további feltétele, hogy a biztosított az általános és különös biztosítási feltételekben foglaltak mellett az alábbi együttes előírásokat is betartja: \n- A tehergépjárművek GPS rendszerrel (24 órás követés) és működő mobiltelefonnal felszereltek.\n- A megbízó fuvarfeladattal kapcsolatos mindennemű előírását kötelezően be kell tartani. \n- Kizárólag a megbízó által adott előírásoknak megfelelő védelmi szintű vagy a megbízó által külön listában meghatározott – de minimum kivilágított, körbekerített, kamerával vagy emberi erővel őrzött - parkolókban állhatnak meg. (Az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.) \n- Amennyiben a megbízó nem határozott meg követelményeket az igénybe vehető parkolókra vonatkozóan, vagy nem írta elő meghatározott parkolók használatát, abban az esetben kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. (Az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.) \n- Ha a tervezett kiszolgáltatás meghiúsul, az új kiszolgáltatási időpontig kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. \n- A szállítás teljes tartama alatt zárva kell tartani a rakteret. \n- A pótkocsikon nem lehet semmilyen jelzés, utalás a szállított árura vonatkozóan. \n- Két gépjárművezetővel végzett fuvarozás esetén az egyik gépjárművezetőnek mindig az autóban kell tartózkodnia. \n- A fuvarfeladatot teljesítő gépjárművezetőnek / gépjárművezetőknek legalább 3 hónapos munkaviszonnyal kell rendelkezni a biztosítottnál. \n- A gépjárművezető az áru kiszolgáltatása során köteles ellenőrizni, hogy a fuvarlevélen illetőleg szállítólevélen megjelölt címzett neve szerinti bélyegzőt használtak–e átvételkor. Eltérés esetén a biztosított még a kiszolgáltatás befejezése, illetve a helyszín elhagyása előtt köteles az eltérést a megbízóval egyeztetni és az egyeztetés eredményét írásban is megküldeni a megbízó részére."
additional_txt_4 = "E záradék alkalmazásával a biztosító kockázatviselése és a biztosítási fedezet kiterjed a mobiltelefonok fuvarozására az alábbi biztonsági előírások betartásával\nA biztosítási fedezet mobiltelen szállításokra csak akkor él, ha a Biztosított a feltételekben foglaltakon kívül az alábbi biztonsági utasításokat is betartja:\n- kizárólag dobozos kamionnal lehet szállítani\n- a járművek rögzített biztonsági raktérzárral ellátottak (SBS speciális lakat)\n- A tehergépjárművek (vontató és pótkocsi is)  GPS rendszerrel (24 órás követés, állandó on-line kapcsolat a távfelügyeleti központtal, jelkimaradás figyelése, adatmentés, min. 30 napos adattárolás) és működő mobiltelefonnal felszereltek.\n- Kizárólag a megbízó által adott előírásoknak megfelelő védelmi szintű, vagy a megbízó által külön listában meghatározott parkolókban állhatnak meg. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.)\n- Amennyiben a megbízó nem határozott meg követelményeket az igénybe vehető parkolókra vonatkozóan, vagy nem írta elő meghatározott parkolók használatát, abban az esetben kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.)\n- Ha a tervezett kiszolgáltatás meghiúsul, az új kiszolgáltatási időpontig kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe.\n- kizárólag a megbízók által megadott útvonalon haladhatnak a járművek, \n- a szállítás teljes tartama alatt zárva kell tartani a rakteret\n- a kiszállítási címek előtt tilos várakozni\n- a pótkocsikon nem lehet semmilyen jelzés, utalás a szállított árura vonatkozóan\n- kizárólag két sofőrrel lehet szállítani, az egyik sofőrnek mindig az autóban kell tartózkodnia\n- a sofőröknek minimum 6 hónapos munkaviszonnyal kell rendelkezni a Szerződőnél\n- a megbízók biztonsági vonatkozó előírásait kötelezően be kell tartani\n- a gépjárművezető kiszolgáltatás során köteles ellenőrizni, hogy a CMR fuvarlevélen megjelölt címzett neve szerinti bélyegzőt használtak –e átvételkor. Eltérés esetén a megbízóval a szerződő kiszolgáltatás előtt köteles egyeztetni ezt dokumentálni."
additional_txt_5 = "E záradék alkalmazásával a biztosító kockázatviselése és a biztosítási fedezet kiterjed a szeszes ital árukra is. E záradék által nyújtott fedezet azonban nem terjed ki a károsodott illetve elveszett áruk jövedéki adótartamára \nE záradék alapján a biztosítási fedezet fennállásának további feltétele, hogy a biztosított az általános és különös biztosítási feltételekben foglaltak mellett az alábbi együttes előírásokat is betartja: \n- A tehergépjárművek GPS rendszerrel (24 órás követés) és működő mobiltelefonnal felszereltek. \n- A megbízó fuvarfeladattal kapcsolatos mindennemű előírását kötelezően be kell tartani.\n - Kizárólag a megbízó által adott előírásoknak megfelelő védelmi szintű, vagy a megbízó által külön listában meghatározott parkolókban állhatnak meg. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.) \n- Amennyiben a megbízó nem határozott meg követelményeket az igénybe vehető parkolókra vonatkozóan, vagy nem írta elő meghatározott parkolók használatát, abban az esetben kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. (Ez az AETR megállapodás szerinti pihenőidőkre és szünetekre egyaránt alkalmazandó.) \n- Ha a tervezett kiszolgáltatás meghiúsul, az új kiszolgáltatási időpontig kizárólag kivilágított, körbekerített, kamerával vagy emberi erővel őrzött parkolók vehetők igénybe. \n- A szállítás teljes tartama alatt zárva kell tartani a rakteret. \n- A pótkocsikon nem lehet semmilyen jelzés, utalás a szállított árura vonatkozóan. \n- Két gépjárművezetővel végzett fuvarozás esetén az egyik gépjárművezetőnek mindig az autóban kell tartózkodnia. \n- A fuvarfeladatot teljesítő gépjárművezetőnek / gépjárművezetőknek legalább 3 hónapos munkaviszonnyal kell rendelkezni a biztosítottnál. \n- A gépjárművezető kiszolgáltatás során köteles ellenőrizni, hogy a fuvarlevélen megjelölt címzett neve szerinti bélyegzőt használtak–e átvételkor. Eltérés esetén a biztosított még a kiszolgáltatás befejezése, illetve a helyszín elhagyása előtt köteles a megbízóval egyeztetni az eltérést és az egyeztetés eredményét írásban is megküldeni a megbízó részére. \nA szeszesital árukban keletkezett károkra az önrészesedés mértéke 20%, de minimum 100 000 Ft"
additional_txt_6 = "Amennyiben a rakodás írásbeli megállapodás alapján a biztosított felelősségére történt a biztosítás fedezete kiterjed az áru fel-, és lerakása során keletkezett károkra, bele nem értve azokat a káreseményeket, melyek idegen tulajdonú rakodóeszközzel a feladó, illetve az átvevő raktárában történtek, valamint bele nem értve az önrakodós teherautóval (KCR daru) végzett rakodásokat.\nRakodás során keletkezett károkra az önrészesedés mértéke: a keletkezett kár 20%-a, de minimum 200 000 Ft"

def format_string(txt):
    return '{:,}'.format(txt).replace(',', ' ')


def add_to_dict(my_dict: dict, new_key: str, new_value: str, duplicate=False):
    new_key = f"{new_key}."
    if duplicate or (new_value not in my_dict.values()):
        my_dict[new_key] = new_value
    else:
        old_key = [key for key, value in my_dict.items() if value == new_value][0]
        my_dict[old_key + " és " + new_key] = new_value
        del my_dict[old_key]
    return my_dict


def get_string(my_dict: dict):
    if len(my_dict) == 1:
        key, value = next(iter(my_dict.items()))
        return value
    else:
        returned_string = ""
        for key, value in my_dict.items():
            returned_string += f"{key} csoport: {value}\n"
    return returned_string[:-1]


def delete_paragraph(paragraph):
    p = paragraph._element
    p.getparent().remove(p)


def set_company_data(para, customer):
    name = para.insert_paragraph_before("")
    name.add_run(f"Szerződő/Biztosított: \t{customer.company_name}").bold = True
    para.insert_paragraph_before(f"Székhely: \t{customer.address}")
    if customer.registration_number != "@":
        para.insert_paragraph_before(f"Cégjegyzékszám: \t{customer.registration_number}")
    para.text = f"Adószám: \t{customer.tax_number}"


def set_transported_goods(para, customer):
    transported_dict = {}
    for group in customer.groups:
        transported_goods = set()
        transported_goods.update(clause[3] for clause in group.cmr_clauses if clause[2])
        transported_goods.update(clause[3] for clause in group.baf_clauses if clause[2])
        new_tg = "normál kereskedelmi áru (csomagolt egységrakomány)" + ''.join(transported_goods)
        add_to_dict(transported_dict, group.group_number[0], new_tg)

    para.text = ""
    para.add_run('Fuvarozott áruk köre:\t').bold = True
    para.add_run(get_string(transported_dict))


def set_excluded_goods(para, customer):
    eg_text = f"{'CMR biztosítási feltételekben' if customer.cmr else ''}" \
              f"{' és a ' if customer.cmr and customer.baf else ''}" \
              f"{'Belföldi közúti árutovábbítási felelősségbiztosítás <BÁF> feltételekben' if customer.baf else ''}"

    excluded_goods = {", mobiltelefon"} if customer.cmr and customer.baf else \
        {", mobiltelefon", ", elektronikai áruk", ", jövedéki termék"}

    for group in customer.groups:
        for i, clause in enumerate(group.cmr_clauses):
            if clause[2]:
                if i == 5 or i == 8:
                    excluded_goods.discard(", jövedéki termék")
                elif i == 6:
                    excluded_goods.discard(", elektronikai áruk")
                elif i == 9:
                    excluded_goods.discard(", mobiltelefon")

        for i, clause in enumerate(group.baf_clauses):
            if clause[2]:
                if i == 5:
                    excluded_goods.discard(", jövedéki termék")
                elif i == 7:
                    excluded_goods.discard(", elektronikai áruk")
                elif i == 9:
                    excluded_goods.discard(", jövedéki termék")

    eg_text += " foglaltakon túl: költözési ingóság" + ''.join(excluded_goods)

    para.text = ""
    para.add_run("Kizárt áruk köre: \t").bold = True
    para.add_run(eg_text)


def set_number_of_truck(para, customer):
    numbers_of_truck = {}
    for group in customer.groups:
        add_to_dict(numbers_of_truck, group.group_number[0], f"{group.number_of_trucks} db jármű", True)

    para.text = ""
    para.add_run("Fuvareszközök száma: \t").bold = True
    para.add_run(get_string(numbers_of_truck))


def set_territorial_scope(para, customer):
    territorial_scope = {}
    for group in customer.groups:
        if group.cmr:
            new_ts = f"földrajzi értelemben vett Európa{', beleértve Magyarország' if group.baf else ''}, " \
                     f"\nkizárva: Ukrajna, FÁK országok, Koszovó, Albánia"
        else:
            new_ts = "Magyarország"
        add_to_dict(territorial_scope, group.group_number[0], new_ts)

    cb = next((group.cabotage for group in customer.groups if group.cabotage), "")

    para.text = ""
    para.add_run("Területi hatály: \t").bold = True
    para.add_run(get_string(territorial_scope))
    if cb:
        para.add_run(f"\nA biztosítás fedezete kiterjed a {cb}ban végzett belföldi közúti árufuvarozások "
                     f"(kabotázs) felelősségi kockázataira a CMR biztosítási feltételek szerint")


def set_payment_frequency(para, customer):
    para.text = ""
    para.add_run("Díjfizetés módja és üteme: \t").bold = True
    freq = {2: "negyed éves", 1: "fél éves", 0: "éves"}
    para.add_run(f"banki átutalás; {freq[customer.payment_frequency]} díjfizetési gyakoriság")



def set_limit(para, customer):
    sub_limit = [False, False]  # Két extra szublimit
    cmr_limits = {}
    baf_limits = {}

    for group in customer.groups:
        for i in range(2, 4):
            if group.baf_clauses[i][2] or group.baf_clauses[i][2]:
                if i == 2:
                    sub_limit[1] = True
                elif i == 3:
                    sub_limit[2] = True
        if group.cmr:
            add_to_dict(cmr_limits, group.group_number[0], group.cmr_limit)
        if group.baf:
            add_to_dict(baf_limits, group.group_number[0], group.baf_limit)

    # Kombinált limit
    cmr_max = max(cmr_limits.values(), default=0)
    baf_max = max(baf_limits.values(), default=0)
    max_cmr = True if cmr_max * 400 > baf_max else False

    total_limits = len(cmr_limits) + len(baf_limits)
    total_limits += sub_limit.count(True)

    comb_limit_text = "Kombinált kártérítési limit: \t" if total_limits > 1 else "Kártérítési limit: \t"
    comb_limit = para.insert_paragraph_before("")
    comb_limit.add_run(comb_limit_text).bold = True

    comb_limit.add_run(f"a CMR Egyezményben foglaltaknak megfelelően a hiányzó, illetve sérült " \
                       f"áru bruttó súlya szerint kilogrammonként max. 8,33 SDR de mindösszesen maximum:\n" \
                       if max_cmr else f"belföldi fuvarozás során okozott károkra:\n")
    comb_limit.add_run(f"EUR {format_string(cmr_max)} / káresemény / év" if cmr_max else \
                       f"{format_string(baf_max)},-Ft / káresemény / év").bold = True

    cb = next((group.cabotage for group in customer.groups if group.cabotage), "")
    if cb:
        comb_limit.add_run("\n\nKivéve a kabotázs fuvarokat, ahol a CMR Egyezményben foglaltaknak megfelelően a hiányzó, illetve sérült áru bruttó súlya szerint\nkilogrammonként max. 8,33 SDR de mindösszesen maximum:\n")
        comb_limit.add_run("EUR 600 000 / káresemény / év").bold = True

    if total_limits > 1:
        sub_limit_p = para.insert_paragraph_before("")
        sub_limit_p.add_run("Szublimit:\t").bold = True

        if sub_limit[0]:
            sub_limit_p.add_run("Hibás lefejtésből eredő károkra: ")
            sub_limit_p.add_run("1 000 000,-Ft / káresemény / év").bold = True
        if sub_limit[1]:
            sub_limit_p.add_run("\n" if len(sub_limit_p.runs) > 1 else "")
            sub_limit_p.add_run("Konténerek káraira: ")
            sub_limit_p.add_run("1 000 000,-Ft / káresemény / év").bold = True

        for key, value in cmr_limits.items():
            if value != cmr_max or not max_cmr:
                sub_limit_p.add_run("\n" if len(sub_limit_p.runs) > 1 else "")
                sub_limit_p.add_run(f"{f'{key} csoport: ' if total_limits > 2 else ''}a CMR Egyezményben foglaltaknak megfelelően a hiányzó, "
                                  f"illetve sérült áru bruttó súlya szerint kilogrammonként max. 8,33 SDR de mindösszesen maximum:\n")
                sub_limit_p.add_run(f"EUR {format_string(value)} káresemény / év").bold = True

        for key, value in baf_limits.items():
            if value != baf_max or max_cmr:
                sub_limit_p.add_run("\n" if len(sub_limit_p.runs) > 1 else "")
                sub_limit_p.add_run(f"{f'{key} csoport: ' if total_limits > 2 else ''}belföldi fuvarozás során okozott károkra:\n")
                sub_limit_p.add_run(f"{format_string(value)},-Ft / káresemény / év").bold = True

    delete_paragraph(para)


def set_fee_per_truck(para, customer):
    para.text = ""
    fee_dict = {}
    for group in customer.groups:
        fpt = f"{format_string(group.fee_per_truck)},- Ft / szerelvény / év"
        add_to_dict(fee_dict, group.group_number[0], fpt, True)

    para.add_run(f"Biztosítási díj: \t{get_string(fee_dict)}").bold = True


def set_all_fee(para, customer):
    full_price = sum(group.fee_per_truck * group.number_of_trucks for group in customer.groups)

    para.text = ""
    para.add_run(f"Biztosítási díj: \t{format_string(full_price)},-Ft").bold = True


def set_additional(para, customer):
    additional_text = set()
    baf_clauses = set()
    cmr_clauses = set()
    for group in customer.groups:
        for i, clause in enumerate(group.cmr_clauses):
            if clause[2]:
                cmr_clauses.add(clause[0])
                if i == 0:
                    additional_text.add(additional_txt_1)
                elif i == 5:
                    additional_text.add(additional_txt_2)
                elif i == 7:
                    additional_text.add(additional_txt_3)
                elif i == 4:
                    additional_text.add(additional_txt_4)

        for i, clause in enumerate(group.baf_clauses):
            if clause[2]:
                baf_clauses.add(clause[0])
                if i == 0:
                    additional_text.add(additional_txt_1)
                elif i == 5:
                    additional_text.add(additional_txt_2)
                elif i == 6:
                    additional_text.add(additional_txt_3)
                elif i == 9:
                    additional_text.add(additional_txt_5)
                elif i == 10:
                    additional_text.add(additional_txt_6)

    additional_txt = "\n".join(additional_text)
    cmr_cl = "\n".join(cmr_clauses)
    baf_cl = "\n".join(baf_clauses)

    para.text = additional_txt
    para.paragraph_format.first_line_indent = 0
    para.paragraph_format.left_indent = 0
    new_par = para.insert_paragraph_before()
    new_par.add_run("Csatolt dokumentumok:\t").bold = True
    if customer.cmr:
        new_par.add_run("Biztosítási termékismertetők (IPID)\nCMR biztosítási feltételek\n").bold = True
        new_par.add_run("Ügyfél- és Adatkezelési tájékoztató, Hasznos tudnivalók\nÁltalános Kárbiztosítási Feltételek\n"
                        "Nemzetközi Közúti Árufuvarozói Felelősségbiztosítás (CMRkf)\nKülönös Feltételek és Záradékok")
        new_par.add_run(cmr_cl)
    if customer.baf:
        if customer.cmr:
            new_par.add_run("\n")
        new_par.add_run("Belföldi közúti árutovábbítási felelősségbiztosítás <BÁF>\n").bold = True
        new_par.add_run("Ügyfél-és Adatkezelési tájékoztató, Hasznos tudnivalók\nÁltalános Kárbiztosítási Feltételek\n"
                        "Belföldi Közúti Árutovábbítási Felelősségbiztosítás Különös Feltételek és Záradékok")
        new_par.add_run(baf_cl)
